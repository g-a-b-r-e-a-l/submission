# SoDaDE: Solvent Data-Driven Embeddings with Small Transformer Models

This README file runs the SoDaDE model pretraining task. It pretrains a small transformer model to predict solvent properties from the dataset `SoDaDE/fingerprint_model/datasets/full_extracted_table.csv` which was extracted from supplementary information of the paper 'Reappraisal of Empirical Solvent Polarity Scales for Organic Solvents' by Dr Spange et al, 2020.

## Installation

This package was built on Python==3.10.18. Necessary packages can be installed using:

```bash
pip install -r requirements.txt
```
We recommend using a python environment for installation. In this case, conda environments were used. There were no dependecy issues raised at the time of writing this, August 2025.

## Datasets

The training dataset is the Spange solvent property dataset. THe columns are as follows:
Molecular Properties
The dataset includes the following molecular properties for each solvent:

ET30: Reichardt's polarity parameter
alpha: Hydrogen-bond donating ability
beta: Hydrogen-bond accepting ability
pi_star : Kamlet-Taft polarizability parameter
SA: Solvent acidity
SB: Solvent basicity
SP: Solvent polarizability
SdP: Solvent dipolarity
N_mol_cm_3 : Molecular density
n: Solvent refractive index
fn: A function of n that quantifies non-specific solute-solvent interactions
delta: A correction term for polarizability

These are ordered into solvent sequences in this format:

```<Begin>, <Solvent_Type>, <ChemBERTa_FP>, <Property_Label_1>, <Value_1>, <Property_Label_2>, <Value_2>, <Property_Label_3>, <Value_3>...<Value_12>, <End>```

For the test, validation and training split scripts are stored with the extracted dataset in the `datasets` directory. Run `data.py` to create the data split and shuffle the solvent sequences 50 times. 

Training solvent properties are z-score normalised and the mean and std deviation are stored in `normalisation_stats.json`. These parameters are used to normalise the validation and testing properties and for unnormalisation later. 

## SoDaDE Model Training

For training, the decoder.py file along with dataset, config, collate and other files are in the `model` directory. For training, values are randomly masked out with a set probability. Run `train.py` to train the model with the optimal parameters.

It saves the model with the best loss on the validation set so far to the directory `SoDaDE/fingerprint_model/saved_models_from_training` and the training and validation loss to `SoDaDE/Loss_over_time.csv`.

## Model Evaluation

For evaluation, the model has to predict the property values for the 5 test values. These sequences are also shuffled 50 times and predictions are recorded in 'test_predictions.json' to understand how prediction performance changes over the sequence. Use arguments 'Template' or 'Scratch' to allow the model to use true values or its own predictions when building solvent sequences and predicting the next solvent property value.

## Comparison Models
The model is compared with a Gaussian process (GP), Random Forest (RF) and the average of the training values for each property (AVG). The code for the GP and RF models is in 'SoDaDE/other_property_prediction_methods'. 

Run `SoDaDE/other_property_prediction_methods/canon_smiles.py` to featurise the solvents. The training data is `train_set.csv` and `val_set.csv` generated by `data.py`. Overfitting is prevented used leave-one-out cross validation. 

`SoDaDE/other_property_prediction_methods/fit_random_forest.py` was run for RF predictions

1. `SoDaDE/other_property_prediction_methods/fit_multitask_gp.py`
2. `SoDaDE/other_property_prediction_methods/fill_TOI_no_norm.py`
were run for GP predictions.

## Model Comparison
Run `eval.py` to test the performance of the property prediction model. 

## Plots
For plotting, the attention layer and word tokens are plotted. These plots are saved in the `create_plots` directory. The `plot.ipynb` contains the code for used to generate the plots. 